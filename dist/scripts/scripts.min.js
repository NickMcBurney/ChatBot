var chatOptions={service:[{name:"Loan",steps:[{name:"amount",step:1,question:"Ok, how much would you like to borrow?",type:"input",options:"",inputValue:""},{name:"monthly",step:2,question:"How much do you want to pay back each month?",type:"input",options:"",inputValue:""},{step:3,question:"What are you using the money for?",type:"buttons",options:["Car or Motorcycle","Debt Consolidation","Holiday","Home Improvements","Wedding","Other"]},{step:4,type:"loading",question:"We're searching for your loan now"},{name:"result",step:5,type:"result",options:{amount:"",term:"",apr:"",monthly:""}}]}]};
function formatPercent(r){if(r){var t=r+"%";return t}}function formatCurrency(r){if(r){nStr=r.toFixed(2),nStr=nStr.replace(/,/g,""),nStr=nStr.replace(/£/g,""),nStr+="",x=nStr.split("."),x1=x[0],x.length>1&&"00"!=x[1]?x2="."+x[1]:x2="";for(var t=/(\d+)(\d{3})/;t.test(x1);)x1=x1.replace(t,"$1,$2");return"£"+x1+x2}}function formatMonths(r){if(r){var t=r/12,n=r%12;t=Math.floor(t);var e="";return e=n>=1&&t<1?n+" months":t>=1&&n<1?t+" years":t>=1&&n>=1&&6==n?t+"½ years":t>=1&&n>=1?t+" years and "+n+" months":""}}function unformat(r){return r.replace("£","").replace(",","").replace("%","")}
function findLoan(o,a,n){var l=a;return o<1500?"false":void(2e3==o?consolidateLoanPL(a,0,l):o<=2500?consolidateLoanPL(a,1,l):o<=3e3?consolidateLoanPL(a,2,l):o<=3500?consolidateLoanPL(a,3,l):o<=4e3?consolidateLoanPL(a,4,l):o<=4500?consolidateLoanPL(a,5,l):o<=5e3?consolidateLoanPL(a,6,l):o>=1e4&&o<=25e4&&consolidateLoanHOL(a,n,o,l))}function consolidateLoanPL(o,a,n){var l=loansAvailable[a].loanAmount,e=loansAvailable[a].loanTerm,t=loansAvailable[a].apr,r=e[e.length-1],u=calculateMonthly(l,r,t);if(u<o&&u<=n)return foundLoan={loanAmount:loansAvailable[a].loanAmount,loanTerm:r,apr:loansAvailable[a].apr,monthly:u},console.log(foundLoan),foundLoan}function consolidateLoanHOL(o,a,n,l){a=a||36;var e=12*Math.ceil(a/12);e>360&&(e=360);var t=12*Math.ceil(a/12)+24;t>360&&(t=360),console.log(e+" "+t);var r=e,u=1e3*Math.ceil(n/1e3),c=calculateApr(u);console.log("apr: "+c);var i=calculateMonthly(u,r,c);if(console.log("monthly: "+i),i<o&&i<=l)return foundLoan={loanAmount:u,loanTerm:r,apr:c,monthly:i},console.log(foundLoan),foundLoan}function calculateMonthly(o,a,n){var l=100*(Math.pow(1+n/100,1/12)-1);l=l.toFixed(4);var e=12*l,t=a-2*a,r=e/1200,u=o,c=u*r,i=1-Math.pow(1+r,t),m=c/i;return m}function termCalculate(o,a,n){var l=unformat(a),e=unformat(o),t=unformat(n),r=(Math.log(t)-Math.log(t-e*l/1200))/Math.log(1+l/1200),u=Math.ceil(10*r)/10,u=Math.round(u),c=u/12;c=Math.floor(c);var i=u%12;if(isFinite(i))return console.log(u),console.log(i),u}function calculateApr(o){var a;return o>=1e3&&o<=3900?a=44.9:o>=4e3&&o<=5e3?a=79.9:o>=1e4&&o<=25e3?a=5.9:o>25e3&&o<=45e3?a=6.4:o>45e3&&o<=65e3?a=5.8:o>65e3&&o<=25e4&&(a=5.4),a}var loansAvailable=[{loanAmount:2e3,loanTerm:[24,30,36],apr:34.9},{loanAmount:2500,loanTerm:[24,30,36],apr:34.9},{loanAmount:3e3,loanTerm:[24,30,36],apr:39.9},{loanAmount:3500,loanTerm:[24,30,36,42],apr:44.9},{loanAmount:4e3,loanTerm:[24,30,36,42,48],apr:44.9},{loanAmount:4500,loanTerm:[24,30,36,42,48],apr:44.9},{loanAmount:5e3,loanTerm:[24,30,36,42,48],apr:44.9}],foundLoan={loanAmount:0,loanTerm:0,apr:0,monthly:0};
function createStep(t,e){var s=(chatOptions.service[e],"step"+t);console.log(chatOptions.service[0].steps[t-1].step),$(step).clone().prop("id",s).insertAfter($("#step"+(t-1))),console.log($("#step"+(t-1)));var n=chatOptions.service[0].steps[t-1].question;createBot(n,$("#"+s));var a=chatOptions.service[0].steps[t-1].type,o=chatOptions.service[0].steps[t-1].options,i=chatOptions.service[0].steps[t-1].name;if("loading"==a)setTimeout(function(){createStep(t+1,e)},1500);else if("result"==a){var p=getResultStepNo(),c=chatOptions.service[0].steps[p-1].options.amount,r=chatOptions.service[0].steps[p-1].options.monthly;findLoan(c,r)}else createUser(a,o,$("#"+s),i);console.log("id: "+s),console.log("message: "+n)}function createBot(t,e){var s=$("<div class='chat-bot hide'></div>");$(e).append($(s).text(t).removeClass("hide"))}function createUser(t,e,s,n){var a=$("<div class='chat-user hide'></div>");if($(s).append($(a).removeClass("hide")),"input"==t)$(a).addClass("chat-input").append("<input data-name='"+n+"'/>");else if("buttons"==t)for(var o=0;o<e.length;o++)$(a).addClass("chat-action").append("<span class='chat-action-option' data-value='"+e[o]+"'></span>")}function nextStep(t,e){var s=$(t).parent().parent().prop("id").replace(/\D/g,""),n=Number(s)+1;createStep(n,e)}function setPropertyValue(t){var e=$(t).val(),s=$(t).data("name");if(e&&s){var n=getResultStepNo();"amount"==s?chatOptions.service[0].steps[n-1].options.amount=e:"monthly"==s&&(chatOptions.service[0].steps[n-1].options.monthly=e)}}function getResultStepNo(){var t=chatOptions.service[0].steps.filter(function(t){return"result"==t.name});return t[0].step}var step=$("<div></div>");$(document).on("keyup",".chat-user input",function(t){13==t.keyCode&&(nextStep($(this)),setPropertyValue($(this)))}),$(document).on("click",".chat-action-option",function(t){var e=$(this).data("no");e?nextStep($(this),e):nextStep($(this))});